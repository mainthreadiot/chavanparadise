<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Management - CHAVAN PARADISE</title>
    <style>
       body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #2D3436 url('https://lh3.googleusercontent.com/p/AF1QipPZV0QdjODym-RluDo_EAFdw9xfep2EBU5kJDOx=s680-w680-h510-rw') no-repeat center center fixed;
    background-size: cover;
    margin: 0;
    min-height: 100vh;
    padding: 0;
    box-sizing: border-box;
    border-radius: 20px;
    overflow-x: hidden;
}

footer {
    text-align: center;
    background-color: rgba(24, 24, 24, 0.9);
    color: white;
    padding: 8px 0;
    position: relative;
    bottom: 0;
    width: 100%;
    font-size: 12px;
    border-top: 1px solid #800000;
    backdrop-filter: blur(10px);
}

#toggle {
    background-color: transparent;
    border: none;
    padding: 8px;
    cursor: pointer;
    border-radius: 50%;
    transition: background-color 0.2s;
}

#toggle:hover {
    background-color: rgba(0, 0, 0, 0.1);
}

#toggle .icon-class {
    font-size: 1.5em;
    color: #000;
}

h3 {
    text-align: center;
    color: white;
    margin: 0;
    background: linear-gradient(135deg, #181818 0%, #2D3436 100%);
    text-transform: uppercase;
    padding: 16px 20px;
    font-size: 1.4rem;
    letter-spacing: 2px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    font-weight: 700;
}

h3 a {
    color: white;
    text-decoration: none;
    transition: color 0.2s;
}

h3 a:hover {
    color: #2e8b57;
}

h5 {
    text-align: center;
    color: white;
    font-weight: bold;
    margin: 8px 0 12px 0;
    font-size: 1rem;
    background: rgba(0, 0, 0, 0.7);
    padding: 8px 12px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

form {
    max-width: 380px;
    width: 95%;
    margin: 8px auto;
    padding: 12px 10px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    gap: 4px;
    backdrop-filter: blur(10px);
}

.select2-container .select2-selection--single {
    height: 36px !important;
    line-height: 36px !important;
    border-radius: 6px !important;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 36px !important;
    padding-left: 12px !important;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px !important;
}

label {
    margin: 2px 0 1px 0;
    font-weight: 600;
    font-size: 0.85rem;
    color: #333;
}

input, textarea, select, option {
    width: 100%;
    padding: 8px 6px;
    margin-bottom: 2px;
    font-size: 0.9rem;
    border-radius: 6px;
    border: 2px solid #e0e0e0;
    box-sizing: border-box;
    transition: all 0.2s ease;
    background: white;
    height: 36px;
}

input:focus, textarea:focus, select:focus {
    border-color: #2e8b57;
    box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
    outline: none;
    transform: translateY(-1px);
}

select {
    width: 100%;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
}

button {
    padding: 8px 14px;
    background: linear-gradient(135deg, #2e8b57 0%, #3cb371 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.3s ease;
    margin-top: 2px;
    box-shadow: 0 4px 15px rgba(46, 139, 87, 0.3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

button:hover {
    background: linear-gradient(135deg, #26734d 0%, #2e8b57 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(46, 139, 87, 0.4);
}

button:active {
    transform: translateY(0);
}

.radio-group {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    margin: 8px 0;
}

.radio-group label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 2px solid #e8e8e8;
    border-radius: 12px;
    padding: 12px 8px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 500;
    transition: all 0.3s ease;
    background: #ffffff;
    position: relative;
    overflow: hidden;
    flex: 1;
    min-width: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    color: #555;
}

.radio-group label:hover {
    border-color: #2e8b57;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(46, 139, 87, 0.15);
    background: #f8fff9;
}

.radio-group input {
    display: none;
}

.radio-group input:checked + label {
    background: linear-gradient(135deg, #2e8b57 0%, #3cb371 100%) !important;
    color: white !important;
    border-color: #2e8b57 !important;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(46, 139, 87, 0.25);
}

.radio-group input:checked + label i {
    color: white !important;
}

.radio-group input:checked + label .visitor-type-text {
    color: white !important;
}

.radio-group input + span {
    display: block;
    width: 20px;
    height: 20px;
    background-color: #f5f5f5;
    border-radius: 50%;
    margin-bottom: 6px;
    transition: all 0.3s ease;
    border: 2px solid #e0e0e0;
}

.radio-group input:checked + span {
    background-color: white;
    transform: scale(1.1);
    border-color: white;
}

.radio-housekeeping span { background-color: #ff9800; border-color: #ff9800; }
.radio-security span { background-color: #ff9800; border-color: #ff9800; }
.radio-relatives span { background-color: #2196F3; border-color: #2196F3; }
.radio-delivery span { background-color: #9C27B0; border-color: #9C27B0; }
.radio-other span { background-color: #FF5722; border-color: #FF5722; }

.radio-group input:checked + .radio-housekeeping span { background-color: white; border-color: white; }
.radio-group input:checked + .radio-security span { background-color: white; border-color: white; }
.radio-group input:checked + .radio-relatives span { background-color: white; border-color: white; }
.radio-group input:checked + .radio-delivery span { background-color: white; border-color: white; }
.radio-group input:checked + .radio-other span { background-color: white; border-color: white; }

.visitor-type-text {
    font-size: 0.7rem;
    font-weight: 600;
    margin-top: 2px;
    text-align: center;
    letter-spacing: 0.3px;
}

#video, #photo {
    width: 50%;
    height: 120px;
    border: 2px solid #2e8b57;
    border-radius: 8px;
    margin: 0;
    display: block;
    object-fit: cover;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    flex: 1;
}

.visitorForm1 {
    position: relative;
}

.mandatory {
    border-color: #2e8b57;
}

.mandatory:focus {
    border-color: #2e8b57;
    box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.2);
}

.error {
    border-color: #ff4444 !important;
    background-color: #fff5f5;
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.error::placeholder {
    color: #ff4444;
    font-weight: bold;
}

.input-group {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap !important;
}

.input-group input {
    flex: 1 1 0%;
    min-width: 0;
}

.input-group button {
    padding: 12px 16px;
    font-size: 1.2rem;
    border-radius: 8px;
    margin: 0;
}

.vehicle-input {
    text-align: center;
    font-weight: bold;
    letter-spacing: 1px;
}

hr {
    border: none;
    height: 1px;
    background: linear-gradient(90deg, transparent, #2e8b57, transparent);
    margin: 16px 0;
}

#toast {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    z-index: 2000;
    font-size: 1rem;
    font-weight: 600;
    animation: slideIn 0.3s ease-out;
    backdrop-filter: blur(10px);
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Mobile Responsive Design */
@media (max-width: 768px) {
    body {
        padding: 4px;
        border-radius: 8px;
    }
    
    form {
        max-width: 98%;
        padding: 12px 8px;
        margin: 8px auto;
        gap: 6px;
    }
    
    h3 {
        font-size: 0.9rem;
        padding: 6px 6px;
    }
    
    h5 {
        font-size: 0.7rem;
        margin: 2px 0 6px 0;
    }
    
    .radio-group {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
    }
    
    .radio-group label {
        padding: 8px 4px;
        font-size: 0.75rem;
    }
    
    input, select, button {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 10px 8px;
    }
    
    button {
        padding: 12px 16px;
        font-size: 0.9rem;
    }
    
    #video, #photo {
        width: 100px;
        height: 100px;
    }
    
    .input-group {
        flex-wrap: nowrap !important;
        gap: 4px;
    }
    
    .input-group input {
        width: 100%;
    }
    
    .vehicle-input-group {
        grid-template-columns: repeat(2, 1fr);
        gap: 4px;
    }
    
    .flat-input-group {
        grid-template-columns: 1fr;
        gap: 6px;
    }
    
    .camera-container {
        flex-direction: row !important;
        gap: 4px;
    }
    
    .form-section label {
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
    }
    
    .speak-btn {
        max-width: 32px;
        font-size: 1em;
        padding: 0 4px;
    }
}

@media (max-width: 480px) {
    form {
        padding: 8px 6px;
    }
    
    .radio-group {
        grid-template-columns: 1fr;
    }
    
    button {
        padding: 10px 16px;
        font-size: 0.85rem;
    }
    
    #toast {
        bottom: 8px;
        right: 8px;
        left: 8px;
        text-align: center;
        font-size: 0.9rem;
        padding: 12px 16px;
    }
    
    .vehicle-input-group {
        grid-template-columns: 1fr;
    }
    
    .vehicle-input-group input {
        font-size: 0.9rem;
    }
    
    .capture-btn, .submit-btn, .main-action-btn {
        padding: 10px 16px;
        font-size: 0.85rem;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    form {
        background: rgba(30, 30, 30, 0.95);
        color: white;
    }
    
    input, select, textarea {
        background: rgba(50, 50, 50, 0.9);
        color: white;
        border-color: #555;
    }
    
    label {
        color: #e0e0e0;
    }
}

/* Additional styles for new form structure */
.form-section {
    margin-bottom: 6px;
}

.form-section label {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 2px;
}

.required {
    color: #ff4444;
    font-weight: bold;
}

.speak-btn {
    min-width: unset;
    max-width: 36px;
    height: 36px;
    padding: 0 6px;
    margin-left: 4px;
    align-self: center;
    font-size: 1.1em;
    white-space: nowrap;
    background: none;
    border: none;
    cursor: pointer;
    border-radius: 50%;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    box-sizing: border-box;
}

.vehicle-input-group {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 4px;
    align-items: center;
}

.vehicle-input-group input {
    text-align: center;
    font-weight: bold;
    letter-spacing: 1px;
    font-size: 0.9rem;
}

.flat-input-group {
    display: grid;
    grid-template-columns: 2fr 2fr;
    gap: 4px;
    align-items: center;
}

.wing-select, .flat-select {
    width: 100%;
    height: 36px;
    border-radius: 6px;
    border: 2px solid #e0e0e0;
    padding: 8px 6px;
    font-size: 0.9rem;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    box-sizing: border-box;
}

.camera-section {
    text-align: center;
    margin: 10px 0;
}

.camera-container {
    display: flex;
    flex-direction: row !important;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    flex-wrap: nowrap;
    width: 100%;
}

.capture-btn {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
    width: 50%;
    margin-left: auto;
    display: block;
}

.submit-btn {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 700;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 12px;
}

.main-action-btn {
    background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 700;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
}

.flat-input-group {
    display: grid;
    grid-template-columns: 2fr 2fr;
    gap: 4px;
    align-items: center;
}

.flat-select {
    width: 100%;
    height: 36px;
    border-radius: 6px;
    border: 2px solid #e0e0e0;
    padding: 8px 6px;
    font-size: 0.9rem;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    box-sizing: border-box;
}

.radio-group label:has(input:checked) {
    background: linear-gradient(135deg, #2e8b57 0%, #3cb371 100%) !important;
    color: white !important;
    border-color: #2e8b57 !important;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(46, 139, 87, 0.25);
}

.radio-group label:has(input:checked) i {
    color: white !important;
}

.radio-group label:has(input:checked) .visitor-type-text {
    color: white !important;
}

.radio-group label:not(:has(input:checked)) i {
    color: inherit;
}

.radio-group label:not(:has(input:checked)) .visitor-type-text {
    color: #555;
}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src='https://kit.fontawesome.com/a076d05399.js'></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
</head> 
<body>
<div id="toast"></div>
<h3><a href="https://cpsociety.co.in/">CHAVAN PARADISE PHASE 1</a></h3>
<h5> Survey No 28 / 26 / 09, Jijamata Chowk Ambeon Pathar Pune, 46</h5>

<form id="visitorForm" class="visitorForm1">  
    <div class="radio-group" style="display:none;">
        <input type="radio" id="gate1" name="gate" value="gate1" required checked >
        <label class="gate1" for="gate1">Gate No 1</label>
    </div>

    <button type="button" id="entrygate1" class="main-action-btn">🚪 Add Visitor 🚪</button>

    <div class="form-section">
        <div class="input-group">
            <input
                type="text"
                id="name"
                name="name"
                maxlength="40" 
                placeholder="Enter visitor name"
                required
                class="mandatory"
            />
            <button type="button" id="toggle-name" title="Speak Name" class="speak-btn">🎙️</button>
        </div>
    </div>

    <div class="form-section">
        <div class="input-group">
            <input 
                type="tel" 
                id="phone" 
                name="phone" 
                maxlength="10" 
                minlength="10" 
                pattern="[0-9]{10}" 
                placeholder="Enter 10-digit number" 
                required 
                class="mandatory"
            >
            <button type="button" id="toggle-phone" title="Speak Phone" class="speak-btn">🎙️</button>
        </div>
    </div>
	
    <div class="form-section" style="display:none;">
        <div class="input-group">
            <input type="number" id="numVisitors" name="numVisitors" value="1" placeholder="Enter visitor count" required min="1" class="mandatory">
        </div>
    </div>

    <div class="form-section">
        <div class="vehicle-input-group">
            <input type="text" id="vehicle1" maxlength="2" minlength="2" name="vehicle1" style="text-transform: uppercase;" placeholder="MH" class="vehicle-input"/>
            <input type="number" id="vehicle2" maxlength="2" minlength="2" name="vehicle2" placeholder="12" class="vehicle-input"/>
            <input type="text" id="vehicle3" maxlength="2" minlength="2" style="text-transform: uppercase;" class="vehicle-input" name="vehicle3" placeholder="XX"/>
            <input type="number" id="vehicle4" name="vehicle4" maxlength="4" minlength="4" pattern="\d{4}" placeholder="XXXX" class="vehicle-input">
        </div>
    </div>

    <div class="form-section">
        <div class="radio-group">
            <label class="radio-relatives">
                <input type="radio" name="visitorType" value="relatives" checked>
                <span></span> 
                <i class="fa fa-user" style="font-size:24px;color:#2196F3;"></i>
                <span class="visitor-type-text">Relatives</span>
            </label>
            <label class="radio-housekeeping"> 
                <input type="radio" name="visitorType" value="housekeeping" required>
                <span></span> 
                <i class="fa fa-home" style="font-size:24px;color:#4CAF50;"></i>
                <span class="visitor-type-text">Housekeeping</span>
            </label>
            <label class="radio-delivery">
                <input type="radio" name="visitorType" value="delivery">
                <span></span> 
                <i class='fa fa-truck' style='font-size:24px;color:purple;'></i>
                <span class="visitor-type-text">Delivery</span>
            </label>
            <label class="radio-other">
                <input type="radio" name="visitorType" value="other">
                <span></span> 
                <i class='fa fa-question' style='font-size:24px;color:#FF5722;'></i>
                <span class="visitor-type-text">Other</span>
            </label>
        </div>
    </div>

    <div class="form-section" id="flatSection">
        <div class="flat-input-group">
            <select id="wingNumber" class="wing-select">
                <option value="A">Wing A</option>
                <option value="B">Wing B</option>
                <option value="C">Wing C</option>
            </select>
            <select id="flatNumber" class="flat-select">
                <option value="">Select Flat</option>
                <option value="101">101</option>
                <option value="102">102</option>
                <option value="103">103</option>
                <option value="104">104</option>
                <option value="105">105</option>
                <option value="106">106</option>
                <option value="201">201</option>
                <option value="202">202</option>
                <option value="203">203</option>
                <option value="204">204</option>
                <option value="205">205</option>
                <option value="206">206</option>
                <option value="301">301</option>
                <option value="302">302</option>
                <option value="303">303</option>
                <option value="304">304</option>
                <option value="305">305</option>
                <option value="306">306</option>
                <option value="401">401</option>
                <option value="402">402</option>
                <option value="403">403</option>
                <option value="404">404</option>
                <option value="405">405</option>
                <option value="406">406</option>
                <option value="501">501</option>
                <option value="502">502</option>
                <option value="503">503</option>
                <option value="504">504</option>
                <option value="505">505</option>
                <option value="506">506</option>
                <option value="601">601</option>
                <option value="602">602</option>
                <option value="603">603</option>
                <option value="604">604</option>
                <option value="605">605</option>
                <option value="606">606</option>
                <option value="701">701</option>
                <option value="702">702</option>
                <option value="703">703</option>
                <option value="704">704</option>
                <option value="705">705</option>
                <option value="706">706</option>
                <option value="801">801</option>
                <option value="802">802</option>
                <option value="803">803</option>
                <option value="804">804</option>
                <option value="805">805</option>
                <option value="806">806</option>
                <option value="901">901</option>
                <option value="902">902</option>
                <option value="903">903</option>
                <option value="904">904</option>
                <option value="905">905</option>
                <option value="906">906</option>
                <option value="1001">1001</option>
                <option value="1002">1002</option>
                <option value="1003">1003</option>
                <option value="1004">1004</option>
                <option value="1005">1005</option>
                <option value="1006">1006</option>
            </select>
        </div>
    </div>
  
    <textarea style="display:none;" id="reason" name="reason" rows="2" placeholder="कारण / Reason"></textarea>

    <div class="camera-section">
        <div class="camera-container" style="flex-direction: row; align-items: center; justify-content: center; gap: 8px;">
            <video id="video" autoplay muted></video>
            <img id="photo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="Captured Image will appear here" />
        </div>
        <button type="button" id="capture" class="capture-btn">📸 Capture Photo</button>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>
    
    <button type="submit" class="submit-btn">✅ Allow Visitor</button>
</form>
 <footer>
        <p>&copy; 2024 Thread IoT. All rights reserved.</p>
    </footer>
<script>
var _contactNumber;
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.display = 'block';

  // Automatically hide the toast after 3 seconds
  setTimeout(() => {
    toast.style.display = 'none';
  }, 3000);
}

document.addEventListener("DOMContentLoaded", function () {
    // Flat number validation
    document.getElementById('flatNumber').addEventListener('change', function () {
        let value = this.value;
        if (this.value === '') return;
        if (parseInt(this.value) < 101 || parseInt(this.value) > 1010) {
            showToast('Please select a flat number between 101 and 1010.');
            this.value = '';
        }
    });

    // Phone number validation
    document.getElementById('phone').addEventListener('input', function (event) {
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    // Vehicle input auto-focus
    const vehicleInputs = document.querySelectorAll('.vehicle-input');
    vehicleInputs.forEach((input, index) => {
        input.addEventListener('input', () => {
            if (input.value.length === parseInt(input.maxLength, 10)) {
                const nextInput = vehicleInputs[index + 1];
                if (nextInput) {
                    nextInput.focus();
                }
            }
        });
    });

    // Conditional validation for wing/flat based on visitor type
    function updateFlatSection() {
        const selectedType = document.querySelector('input[name="visitorType"]:checked').value;
        const flatSection = document.getElementById('flatSection');
        const wingSelect = document.getElementById('wingNumber');
        const flatSelect = document.getElementById('flatNumber');
        
        if (selectedType === 'relatives' || selectedType === 'delivery') {
            // Make wing and flat required
            wingSelect.required = true;
            flatSelect.required = true;
            wingSelect.classList.add('mandatory');
            flatSelect.classList.add('mandatory');
            flatSection.style.display = 'block';
        } else {
            // Make wing and flat optional
            wingSelect.required = false;
            flatSelect.required = false;
            wingSelect.classList.remove('mandatory');
            flatSelect.classList.remove('mandatory');
            flatSection.style.display = 'block'; // Keep visible but not required
        }
    }

    // Add event listeners for radio button changes
    document.querySelectorAll('input[name="visitorType"]').forEach(radio => {
        radio.addEventListener('change', updateFlatSection);
    });

    // Initialize flat section on page load
    updateFlatSection();

    // Resize canvas function
    function resizeCanvas(canvas, maxWidth, maxHeight) {
        const tempCanvas = document.createElement("canvas");
        const ctx = tempCanvas.getContext("2d");
        let width = canvas.width;
        let height = canvas.height;
        const scale = Math.min(maxWidth / width, maxHeight / height);
        width *= scale;
        height *= scale;
        tempCanvas.width = width;
        tempCanvas.height = height;
        ctx.drawImage(canvas, 0, 0, width, height);
        return tempCanvas;
    }

    // Initialize Select2 for dropdown with search
    $('#flatNumber').select2({
        placeholder: 'Search and select flat number...',
        allowClear: true,
        width: '100%',
        dropdownParent: $('body')
    });

    // Camera functionality
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const photo = document.getElementById('photo');
    const captureButton = document.getElementById('capture');
    let base64Image = "";

    navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } }
    })
    .then(stream => {
        video.srcObject = stream;
    })
    .catch(err => {
        console.error("Error accessing camera:", err);
        alert("Camera access denied. Please check your permissions.");
    });

    captureButton.addEventListener('click', () => {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        base64Image = canvas.toDataURL('image/png');
        photo.setAttribute('src', base64Image);
    });

    // Form submission
    $('#visitorForm').on('submit', function (event) {
        event.preventDefault();
        
        // Get selected visitor type
        const selectedType = $('input[name="visitorType"]:checked').val();
        
        // Validate wing/flat for relatives and delivery
        if ((selectedType === 'relatives' || selectedType === 'delivery') && 
            (!$('#wingNumber').val() || !$('#flatNumber').val())) {
            showToast('Wing and Flat number are required for ' + selectedType + ' visitors.');
            return;
        }
        
        const compressedCanvas = resizeCanvas(canvas, 2048, 2048);
        base64Image = compressedCanvas.toDataURL('image/jpeg', 0.1);
        
        const data = {
            "Entity": {
                "Name": $('#name').val(),
                "MobileNumber": $('#phone').val(),
                "VehicleNumber": $('#vehicle1').val()+""+$('#vehicle2').val()+" "+$('#vehicle3').val() +" "+$('#vehicle4').val(),
                "VisitorCount": document.getElementById("numVisitors").value,
                "FlatNo": $('#wingNumber').val() +"_"+$('#flatNumber').val(),
                "Reason": selectedType, // Use selected radio button value as reason
                "Image": base64Image,
                "VisitorType": 1,
                "LoginTime": new Date().toISOString(),
                "LogoutTime": new Date().toISOString(),
                "ApprovalStatus": 0,
                "Extra1": "Extra data 1",
                "Extra2": "Extra data 2",
                "Extra3": "Extra data 3",
                "Extra4": "Extra data 4",
                "Extra5": "Extra data 5"
            }
        };

        fetch("https://cpsociety.co.in/Services/Visitor/VisitorInfo/create", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
            return response.json();
        })
        .then(result => {
            showToast("Visitor Entry Added");
            $('#name').val('');
            $('#phone').val('');
            $('#vehicle1').val('');
            $('#vehicle2').val('');
            $('#vehicle3').val('');
            $('#vehicle4').val('');
            $('#wingNumber').val('A');
            $('#flatNumber').val('');
            $('#photo').attr('src', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==');
            $('input[name="visitorType"]').prop('checked', false);
            $('input[name="visitorType"][value="relatives"]').prop('checked', true);
            updateFlatSection(); // Update flat section after form reset
        })
        .catch(error => {
            showToast(`Error: ${error.message}`);
        });
    });

    // Speech recognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        function setupSpeech(btnId, inputId) {
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            const btn = document.getElementById(btnId);
            const input = document.getElementById(inputId);
            let isListening = false;
            
            recognition.onresult = (event) => {
                let transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                input.value = transcript.trim();
                btn.innerText = "🎙️";
                isListening = false;
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                btn.innerText = "🎙️";
                isListening = false;
            };
            
            recognition.onend = () => {
                btn.innerText = "🎙️";
                isListening = false;
            };
            
            btn.onclick = () => {
                if (isListening) {
                    recognition.stop();
                    btn.innerText = "🎙️";
                } else {
                    recognition.start();
                    btn.innerText = "🛑";
                }
                isListening = !isListening;
            };
        }
        
        setupSpeech("toggle-name", "name");
        setupSpeech("toggle-phone", "phone");
    } else {
        showToast("Speech recognition not supported. Use Chrome or Edge.");
    }
});
</script>

</body>
</html> 
